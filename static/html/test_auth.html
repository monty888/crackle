<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test auths</title>

    <script src="../script/nostr.js"></script>
</head>
<body>

<input id="priv_hex" type="text" placeholder="priv_hex" autofocus/><br>
<input id="file_text" type="text" placeholder="filename" disabled/>
<input id="go_but" type="button" value="go!" disabled/>
<div id="fetch_status"></div>


<script>
    "use strict";
    let priv_txt = document.getElementById('priv_hex'),
        go_but = document.getElementById('go_but'),
        file_txt = document.getElementById('file_text'),
        status_con = document.getElementById('fetch_status'),
        id = 0,
        use_priv = null;


    function get_priv(value){
        try{
            NOSTR.getPublicKey(value);
            use_priv = value
        }catch(e){
            use_priv = null;
        }


        go_but.disabled = file_txt.disabled = use_priv===null;

    }

    priv_txt.addEventListener('keyup', (e) => {
        get_priv(priv_txt.value);
    });
    get_priv(priv_txt.value)

    go_but.addEventListener('click', (e) => {
        do_fetch(file_txt.value);
    });


    async function generate_auth_event(url){
        let auth_evt = {
                id: null,
                pubkey: NOSTR.getPublicKey(use_priv),
                content: '',
                kind: 27235,
                created_at: Math.floor(Date.now() / 1000),
                tags: [
                    ['u', window.location.protocol + '//' + window.location.host + url],
                    ['method', 'GET']
                ]
            },
            ret;

        auth_evt.id = await NOSTR.calculateId(auth_evt);
        auth_evt.sig = await NOSTR.signId(use_priv, auth_evt.id);

        // return the auth event stringified and base64encode to be used in auth header
        return btoa(JSON.stringify(auth_evt));

    }

    async function do_fetch(resource){
        let response,
            img_data,
            img_url,
            img_el,
            img_con_el;


        response = await fetch(resource, {
            method: 'GET',
            headers: {
                'Auth': await generate_auth_event(resource)
            }
        })


        let result_line = [
            '<div>',
            '<span style="display:inline-block;width:100px" >' + response.status + '</span>',
            '<span style="display:inline-block;width:200px">' + response.statusText + '</span>',
            '<span style="display:inline-block;width:200px">' + resource + '</span>',
            '<span id="img-con-'+ id +'" style="display:inline-block;width:500px"></span>',
            '</div>'
        ];

        status_con.insertAdjacentHTML('afterbegin', result_line.join(''));
        img_con_el = document.getElementById('img-con-'+id);

        if(response.status == 200){
            img_data = await response.blob();
            img_url = URL.createObjectURL(img_data);
            img_el = document.createElement("img");
            img_el.src = img_url;
            img_el.style.height = '100px';
            img_el.style.width = '100px';


            img_con_el.appendChild(img_el);
        }



        id +=1;
    }





</script>
</body>
</html>